server {
        # Сервер админки и JS для плагина
        listen *:443;
        server_name luckyway.info;
        ssl on;
        ssl_certificate /etc/ssl/private/luckyway_info.crt;
        ssl_certificate_key /etc/ssl/private/luckyway_info.key;
        ssl_ciphers RC4:HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers on;
        access_log  /var/log/nginx/access.log;
        error_log   /var/log/nginx/error.log;

        rewrite ^/c/(.*?)\.js$ /static/js/$1.js last;

	# default code root
	set $code_root	/srv/redirector/code;

        location / {
            # Локейшен для вспомогательных одностраничных приложений
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_pass http://127.0.0.1:8000;
        }

        location /admin/ {
            # Локейшен джанго-админки
            allow 91.193.167.0/24; # для которых ограничен доступ в админку
            deny all;

            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_pass http://127.0.0.1:8000;
        }

        location /transform/ {
            # Локейшен одностраничного приложения-трансформатора URL
            allow 91.193.167.0/24; # С которых разрешён доступ на трансформатор
            deny all;
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_pass http://127.0.0.1:8000;
        }

        location /media/ {
            # Локейшен медиа-файлов - картинок для лэндинга
            alias $code_root/djangoweb/media/;
            expires 30d;
        }

        location /static/js/ {
            # Локейшен джаваскрипта
            add_header    Cache-Control  no-cache;
            alias $code_root/txmirror/static/js/;
        }

        location /static/ {
            # Локейшен статических файлов фреймворка джанго
            alias $code_root/gateway/static/;
            expires 30d;
        }

        location /logs/ {
            # Локейшен для чтения логов разработчиками
            alias $code_root/spool/logs/;
            auth_basic            "Restricted";
            auth_basic_user_file  /home/nedoban/htpasswd;
            autoindex on;
        }

    }


upstream ha_upstream {
	# Для балансинга
        server 127.0.0.1:10000 fail_timeout=1s;
        server 188.164.255.126:80 backup;
}

server {
        listen      *:80;
        # Имена серверов на которых отвечает редиректор. Рекомендуется
        server_name luckyway.info;
        access_log  /var/log/nginx/access.log;
        error_log   /var/log/nginx/error.log;


        rewrite ^/c/(.*?)\.js$ /static/js/$1.js last;

	# default code root
        set $code_root  /srv/redirector/code;


        location /c {
            # Локейшен для JS файлов
            add_header    Cache-Control  no-cache;
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_pass http://ha_upstream;
        }

        location /c/bc51e0e13/ {
            # Локейшен для редиректов с плагина
            add_header    Cache-Control  no-cache;
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_pass http://ha_upstream;
        }

        location /go {
            # Локейшен для редиректов через минифицированные URL
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_pass http://ha_upstream;
        }

        location /media/ {
            # Локейшен для картинок с лэндинга
            alias $code_root/djangoweb/media/;
            expires 30d;
        }


    location /static/ {
        # Локейшен для статики
        add_header    Cache-Control  no-cache;
        alias $code_root/gateway/static/;
    }

   location /favicon.ico {
         # И нкаонец локейшен для фавикона
         alias $code_root/gateway/static/favicon.ico;
   }
}
